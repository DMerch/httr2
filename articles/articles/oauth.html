<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>oauth • httr2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="oauth">
<meta property="og:description" content="httr2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">httr2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/oauth.html">oauth</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/httr2/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="oauth_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>oauth</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/httr2/blob/master/vignettes/articles/oauth.Rmd"><code>vignettes/articles/oauth.Rmd</code></a></small>
      <div class="hidden name"><code>oauth.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://httr2.r-lib.org">httr2</a></span><span class="op">)</span></code></pre></div>
<div id="rfc6749-oauth-2-0" class="section level2">
<h2 class="hasAnchor">
<a href="#rfc6749-oauth-2-0" class="anchor"></a>RFC6749: OAuth 2.0</h2>
<p>Allows third party to authenticate on behalf or on its own behalf.</p>
<p>Instead of sharing your username and password with a third party, you instead give the 3rd party permission to perform actions on your behalf.</p>
<p>resource owner = user; user-agent = browser;</p>
<p>Basic flow:</p>
<ul>
<li><p>Client makes authorisation request to resource owner, and it returns an authorisation grant (four types are defined in this rfc: authorisation code, implicit, resource owner password credentials, and client credentials).</p></li>
<li><p>Client makes authorisation grant to authorisation server (which can be different to resource server, even though that appears to be rare in practice) which returns access token. Can also provides a refresh token which is a way to get new access tokens (which either have limited lifetime or limited scope; this reduces impact of MITM attacks).</p></li>
<li><p>Client uses access token to access protected resources.</p></li>
</ul>
<div id="client-setup" class="section level3">
<h3 class="hasAnchor">
<a href="#client-setup" class="anchor"></a>Client setup</h3>
<p>Resource server provides some way to register a new client.</p>
<p><strong>Confidential</strong> client can keep secrets from resource owner; <strong>public</strong> clients can not.</p>
<p>Client profiles:</p>
<ul>
<li><p>web app: can manage secrets only accessible to client authors</p></li>
<li><p>user-agent-based (i.e in browser): all credentials accessible to resource owner; can easily use browser auth</p></li>
<li><p>native: public client installed on device used by resource owner. generally possible to extract secrets with some effort.</p></li>
</ul>
<p>Each client is identified by a (non secret) client id.</p>
<p>For client to authenticate to authorisation sever:</p>
<ul>
<li><p>Can use HTTP basic auth with client ID as user name and client secret as password.</p></li>
<li><p>Can also (but not recommended) include in form encoded request body</p></li>
<li><p>Also free to use own setup.</p></li>
</ul>
</div>
</div>
<div id="rc6750-bearer-token-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#rc6750-bearer-token-usage" class="anchor"></a>RC6750: Bearer Token Usage</h2>
<p><a href="https://datatracker.ietf.org/doc/html/rfc6750" class="uri">https://datatracker.ietf.org/doc/html/rfc6750</a></p>
<p>Defines how to use a bearer token. (A bearer token is an opaque string that is meaningful to the server.)</p>
<p>Three options in order of preference:</p>
<ul>
<li><p>In header: <code>Authorization: Bearer mF_9.B5f-4.1JqM</code></p></li>
<li>
<p>Form encoded in body. Can’t use for GET. Can include other parameters.</p>
<pre><code> POST /resource HTTP/1.1
 Host: server.example.com
 Content-Type: application/x-www-form-urlencodedsla

 access_token=mF_9.B5f-4.1JqM</code></pre>
</li>
<li>
<p>In query parameter:</p>
<pre><code>GET /resource?access_token=mF_9.B5f-4.1JqM HTTP/1.1
Host: server.example.com</code></pre>
<p>Request should also include <code>Cache-Control: no-store</code>. Least favoured because easy to leak in logs, history, etc.</p>
</li>
</ul>
<p>If client doesn’t provide one these, server <strong>must</strong> include <code>WWW-authenticate</code> header. Can include attributes:</p>
<ul>
<li><p>realm (may) from RFC2617</p></li>
<li><p>scope (may): “space-delimited list of case-sensitive scopes” indicating required scopes.</p></li>
<li><p>error (should), error_description (may), error_uri (may): error code + optional description and link to learn more. Error code is one of invalid_request (400), invalid_token (401), insufficient_scope (403)</p></li>
</ul>
<!-- --><pre><code> HTTP/1.1 401 Unauthorized
 WWW-Authenticate: 
   Bearer realm="example",
   error="invalid_token",
   error_description="The access token expired"</code></pre>
</div>
<div id="grant-typesflows" class="section level2">
<h2 class="hasAnchor">
<a href="#grant-typesflows" class="anchor"></a>Grant types/flows</h2>
<div id="authorisation-code-with-pkce-native-app-rfc8252" class="section level3">
<h3 class="hasAnchor">
<a href="#authorisation-code-with-pkce-native-app-rfc8252" class="anchor"></a>Authorisation code with PKCE (native app) (RFC8252)</h3>
<p><a href="https://datatracker.ietf.org/doc/html/rfc8252" class="uri">https://datatracker.ietf.org/doc/html/rfc8252</a>; <code>grant_type: authorization_code</code> + public client, since no true way for a native (desktop or mobile) to keep a secret.</p>
<p>Should use PKCE (<a href="https://datatracker.ietf.org/doc/html/rfc7636" class="uri">&lt;https://datatracker.ietf.org/doc/html/rfc7636&gt;</a>)</p>
<p>Examples: <a href="https://developers.google.com/identity/protocols/oauth2/native-app">Google</a> (but requires client_secret in when getting access/refresh token).</p>
</div>
<div id="authorisation-code-web-app-rfc6749" class="section level3">
<h3 class="hasAnchor">
<a href="#authorisation-code-web-app-rfc6749" class="anchor"></a>Authorisation code (web app) (RFC6749)</h3>
<p><a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.1" class="uri">https://datatracker.ietf.org/doc/html/rfc6749#section-4.1</a>; <code>grant_type: authorization_code</code>.</p>
<p>Standard flow where user logs into resource server, then client gets code via redirect. Browser (user-agent) never sees token. Not perfectly suited for an R package, but it’s the only form supported by many APIs so we do the best we can.</p>
<p>Examples: <a href="https://developers.google.com/identity/protocols/oauth2/web-server">Google</a>, <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow">Azure</a>, <a href="https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps#web-application-flow">GitHub</a>,</p>
</div>
<div id="device-rfc8628" class="section level3">
<h3 class="hasAnchor">
<a href="#device-rfc8628" class="anchor"></a>Device (RFC8628)</h3>
<p><a href="https://datatracker.ietf.org/doc/html/rfc8628" class="uri">https://datatracker.ietf.org/doc/html/rfc8628</a>; <code>grant_type: urn:ietf:params:oauth:grant-type:device_code</code></p>
<p>Examples: <a href="https://developers.google.com/identity/protocols/oauth2/limited-input-device">Google</a>, <a href="https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps#device-flow">Github</a>.</p>
</div>
<div id="implicit-rfc6749" class="section level3">
<h3 class="hasAnchor">
<a href="#implicit-rfc6749" class="anchor"></a>Implicit (RFC6749)</h3>
<p><a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.2" class="uri">https://datatracker.ietf.org/doc/html/rfc6749#section-4.2</a></p>
<p>Skip authorisation code, and get access token directly. Authorisation server does not authenticate client (??). No refresh tokens. Useful if you really don’t want to store client secret.</p>
<p>Now mostly deprecated:<a href="https://developer.okta.com/blog/2019/05/01/is-the-oauth-implicit-flow-dead" class="uri">https://developer.okta.com/blog/2019/05/01/is-the-oauth-implicit-flow-dead</a></p>
<p>Difficult to get with non-native web apps because it returns the auth information in the url fragment which is never sent to the server (although we could of course hack around that with some js). But together with the previous point suggests that it’s not appropriate to implement in httr2.</p>
<p>Examples: <a href="https://developers.google.com/identity/protocols/oauth2/javascript-implicit-flow">Google</a>.</p>
</div>
<div id="refresh-token-6749" class="section level3">
<h3 class="hasAnchor">
<a href="#refresh-token-6749" class="anchor"></a>Refresh token (6749)</h3>
<p><a href="https://datatracker.ietf.org/doc/html/rfc6749#section-6" class="uri">https://datatracker.ietf.org/doc/html/rfc6749#section-6</a>; <code>grant_type: refresh_token</code></p>
<p>Refresh token is bound to client; if client is confidential must authenticate.</p>
</div>
<div id="token-exchange-rfc8693" class="section level3">
<h3 class="hasAnchor">
<a href="#token-exchange-rfc8693" class="anchor"></a>Token exchange (RFC8693)</h3>
<p><a href="https://datatracker.ietf.org/doc/html/rfc8693" class="uri">&lt;https://datatracker.ietf.org/doc/html/rfc8693&gt;</a></p>
</div>
<div id="jwt-rfc7523" class="section level3">
<h3 class="hasAnchor">
<a href="#jwt-rfc7523" class="anchor"></a>JWT (RFC7523)</h3>
<p>Examples: <a href="https://developers.google.com/identity/protocols/oauth2/service-account#httprest">Google</a>.</p>
</div>
<div id="client-credentials-rfc6749" class="section level3">
<h3 class="hasAnchor">
<a href="#client-credentials-rfc6749" class="anchor"></a>Client credentials (RFC6749)</h3>
<p>Used when client is acting on its own behalf.</p>
</div>
<div id="resource-owner-password-rfc6749" class="section level3">
<h3 class="hasAnchor">
<a href="#resource-owner-password-rfc6749" class="anchor"></a>Resource owner password (RFC6749)</h3>
<p>Use username &amp; password once to get an access (so client doesn’t need to store them.</p>
</div>
</div>
<div id="extensibility" class="section level2">
<h2 class="hasAnchor">
<a href="#extensibility" class="anchor"></a>Extensibility</h2>
<p>Every API seems to differ a little bit - the major flow is all the same but there are additional query parameters you might want to pass along, the auth is slightly different, and there might be additional content that you want to expose to the user. How do we expose this to the user?</p>
<ol style="list-style-type: decimal">
<li>
<p>Export the individual functions that power each flow - if your API varies from the spec, you can provide a complete function.</p>
<p><strong>Pros</strong>: total flexibility</p>
<p><strong>Cons</strong>: have to export a lot of functions; user has to do a lot of work (and this is not trivial code)</p>
</li>
<li><p>Provide S3 methods</p></li>
<li><p>Provide individual arguments - this would match the API elsewhere in httr2, but I don’t think it can work here; there are just too many places where variation might occur.</p></li>
<li><p>Bundle together functions into a list.</p></li>
<li><p>Bundle together functions into a R6 object. Would make it easier to flow state across pieces</p></li>
</ol>
<p>Current thinking - provide obvious extension points, and export components so that you can reuse if needed.</p>
<div id="token-caching" class="section level3">
<h3 class="hasAnchor">
<a href="#token-caching" class="anchor"></a>Token caching</h3>
<p>An oauth flow is a relatively complicated process, and even when no user interaction is required you want to do it as infrequently as possible. This implies that once you’ve performed a flow and received a token you want to cache it.</p>
<p>At a minimum you want to cache within the current session so that use of the same flow with the same app automatically returns the same token.</p>
<p>The user may also want to opt-in to saving the token on disk for use in future sessions.</p>
<p>each request has an oauth flow and a cache policy (which defaults to caching within a session only; by default there’s one token per client id, but you can add additional keys if you want).When you make a request, we look up the token from the cache, and if it’s not present we use the flow to get a new token. If the token has expired and has a refresh token, we automatically refresh before the first request.If the request errors with a 401 and error <code>invalid_token</code> then we first try the refresh token, and then if that fails, we re-run the full flow.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
